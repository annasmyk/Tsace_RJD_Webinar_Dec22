---
title: |
 | Using JDemetra+ in R: from version 2 to version 3 
 | Presentation 2: Seasonal adjustment in R
subtitle: "TSACE Webinar, Wednesday December 14th 2022"
author: "Anna Smyk and Tanguy Barthelemy"
division: |
    | With the collaboration of Alain Quartier-la-tente
    | 
logo: "img/SACElogo"
automaticcontents: true
automaticcontentstext: "Contents"
output:
    beamer_presentation:
        template: template_Beamer.tex
        keep_tex: yes
        theme: TorinoTh
        slide_level: 3
        includes:
          in_header: preamble_beamer.tex
themeoptions: "coding=utf8,language=english"
classoption: 'usepdftitle=false,french' #handout
fontsize: 10pt
bibliography: [biblio.bib]
biblio-style: unsrtnat
natbiboptions: [numbers]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = F, 
                      fig.align = 'center',
                      fig.path = "img/markdown-")
library(knitr)
library(kableExtra)
library(microbenchmark)
library(ggplot2)
library(RJDemetra)
library(rjd3toolkit)
library(rjd3modelling)
library(rjd3sa)
library(rjd3arima)
library(rjd3x13)
library(rjd3tramoseats)
library(rjdemetra3)
library(ggdemetra3)

# library(rjd3sts)
# library(rjd3highfreq)

# library(rjd3bench)
fig.ext <- "pdf"
is_html <- knitr::is_html_output()
is_latex <- knitr::is_latex_output()
fig.ext = "pdf"
if(is_html){
    fa_arrow_circle_right <- '<i class="fas fa-arrow-circle-right"></i>'
    fa_r_project <- '<i class="fab fa-r-project"></i>'
}else {
    if(is_latex){
        fa_arrow_circle_right <- "\\faIcon{arrow-circle-right}"
        fa_r_project <- "\\faIcon{r-project}"
        fa_java <- "\\faIcon{java}"
    }else {
        fa_arrow_circle_right <- "->"
        fa_r_project <- 'R'
    }
}
options(width = 60)
def.par <- par(no.readonly = TRUE)
```

```{r, eval=TRUE, echo=FALSE}
ipi<-read.csv2("Data/IPI_nace4.csv")
ipi$date<-as.Date(ipi$date,format="%d/%m/%Y")
ipi[,-1]<-sapply(ipi[,-1],as.numeric)
# creating a TS object from a data frame 
y_raw<-ts(ipi[,"RF3030"],frequency=12,start=c(1990,1),end=c(2019,6))
y_new<-ts(ipi[,"RF3030"],frequency=12,start=c(1990,1),end=c(2019,9))


```

# Introduction 

### Outline table 

### Data formats

here, no workspace structure 
- assets
- shortcomings 


### SA process 

- testing for seasonality 
- pre treatement 
- decomposition 
- output series 
- diagnostics 
- customize parameters 
- repeat..

comp with GUI main panels ?

### rjd3 suite of packages for SA

in v2 : 

in v3: more tools (tests,...)



# Time series tools (new in v3)

### Testing for seasonality  
Data format TS object (num vector for HF)
### Normality test

### Autocorrelation 


# X13 (...and some Tramo-seats)

## Quick Launch with default specifications 

### Quick Launch with default specifications (1)

specifications 
- x13
- regarima 
- x11 (one less spec in default x13)

- Specification: created with `spec_x11_default()`, `spec_x13_default()`, `spec_regarima_default()` 

spec_regarima_default(name = c("rg4", "rg0", "rg1", "rg2c", "rg3", "rg5c"))

spec_x13_default(name = c("rsa4", "rsa0", "rsa1", "rsa2c", "rsa3", "rsa5c"))

spec_x11_default()

### Quick Launch with default specifications (2)

- Apply model with `x11()`, `x13()`, `fast.x13()`, `regarima()`, `fast.regarima()`

### Running SA estimation process

in version 2
```{r,eval=TRUE, include=TRUE}
# X13
sa_x13_v2<-RJDemetra::x13(y_raw, spec ="RSA5c")

#Tramo-Seats
sa_ts_v2<-RJDemetra::tramoseats(y_raw, spec ="RSAfull")
```

in version 3
```{r,eval=TRUE, include=TRUE}
#X13
sa_x13_v3 <- rjd3x13::x13(y_raw, spec= "RSA5")

#Tramo seats
sa_ts_v3 <- rjd3tramoseats::tramoseats(y_raw, spec= "RSAfull")

```

affichage output ?


### Running only pre-adjustment


in version 2
```{r,eval=TRUE, include=TRUE}
# Reg-Arima part from X13 only (different default spec names, cf help pages)
regA_v2<-RJDemetra::regarima_x13(y_raw, spec ="RG5c")

# Tramo only 
tramo_v2<-RJDemetra::regarima_tramoseats(y_raw,
  spec = "TRfull")
```

in version 3
```{r,eval=TRUE, include=TRUE}
#X13
sa_regarima_v3 <- rjd3x13::regarima(y_raw)

#Tramo seats (if no spec indicated what is the defalut ?)
# retrouver en 
sa_tramo_v3 <- rjd3tramoseats::tramo(y_raw)

# "fast." versions...(cf output structure)
```

affichage output ?


### Running only decomposition

in version 2
```{r,eval=TRUE, include=TRUE}
# X11 (spec option)
X11_v2<-RJDemetra::x13(y_raw, spec ="X11")

#Tramo-Seats ? you 
#sa_ts_v2<-RJDemetra::tramoseats(y_raw, spec ="RSAfull")
```

in version 3
```{r,eval=TRUE, include=TRUE}
#X11
x11_v3 <- rjd3x13::x11(y_raw)

#Tramo seats
#sa_ts_v3 <- rjd3tramoseats::seats.decompose(y_raw)

```



affichage output ?


## Rerieving output and data visualization

### Output structure  v2
show the list of lists
do a new version 

### Output structure  v3 (cf txt file)
show the NEW list of lists

### Differences from v2 to v3

highlight deifferences: 
- specs
- specs direct accessible + 2 concepts
(spec in v12 was point spec;, more about this in refresh section)

### Retrieve output series 

input and output  = TS objects (not when using specific extensions for HF data)
- final series : different 
```{r,eval=TRUE, include=TRUE}
# Version 2 (affichage main, d tables in user def output)
sa_x13_v2$final$series
sa_x13_v2$final$forecasts

  # Version 3 
# final seasonally adjusted series
sa_x13_v3$result$final$d11final


```

in v3 much more series available without using user defined output

### Series from preadjustement

```{r,eval=TRUE, include=TRUE}
# Version 2 (affichage main, d tables in user def output)
sa_x13_v2$regarima$model$effects # data frame

# forecast accessible only via user defined output (cf below)

# Version 3: "x11 names" : preadjustement effets as stored in the A table
# add doc on names   
sa_x13_v3$result$preadjust$a6


```

### Series from decompostion


```{r,eval=TRUE, include=TRUE}
# Version 2 (affichage main, d tables in user def output)

# D tables accessible via user-defined output,

# forecast accessible only via user defined output (cf below)

# Version 3: "x11 names" : preadjustement effets as stored in the A table
# add doc on names   
sa_x13_v3$result$decomposition$d5 # tables from D1 to D13


```


### Retrieve Diagnostics

Just fetch the needed objects in the relevant par of the output structure or print the whole "model"

```{r,eval=TRUE, include=TRUE}
# Version 2 
print(sa_x13_v2)
#pdf ?
sa_x13_v2$decomposition$mstats
sa_x13_v2$decomposition$s_filter
sa_x13_v2$decomposition$t_filter
# version 3
print(sa_x13_v2)

```
What is missing (series or diagnostics) can be retrieved adding user-defined output in the options 
(more available by default in v3)

### Retrieve user defined-output (1/2)
In v2 or v3 : define a vector of objects your wish to add

Lists of avaible diagnostics or series 
```{r,eval=FALSE, include=TRUE}
# Version 2 
user_defined_variables("X13-ARIMA") 
user_defined_variables("TRAMO-SEATS")
# Version 3: more specific functions 
userdefined_variables_tramoseats("tramoseats")
userdefined_variables_tramoseats("tramo") # restriction

userdefined_variables_x13("regarima") #restrction
userdefined_variables_x13()

```

### Retrieve user defined-output (2/2)


Select the objects and customize estimation function
```{r,eval=TRUE, include=TRUE}
# version 3
ud<-userdefined_variables_x13()[15:17] # b series
ud
sa_x13_v3_UD<-rjd3x13::x13(y_raw,"RSA5c",userdefined=ud)
sa_x13_v3_UD$user_defined # remainder of the names 
# retrieve the object 
sa_x13_v3_UD$user_defined$decomposition.b1


```


### Plots and data visualisation (1/2) {.allowframebreaks} 

In version 2 3 kinds of plots : final (2 types), regarima and SI ratios 
```{r,eval=TRUE, include=TRUE}
# version 2
# for class 'final' : 2 types 
# syntaxe min 
plot(sa_x13_v2, type_chart = "sa-trend", first_date = c(2015, 1))
plot(sa_x13_v2, type= "cal-seas-irr",first_date = c(2015, 1))


layout(matrix(1:6, 3, 2));plot(sa_x13_v2$regarima,ask = FALSE)

# Plotting SI ratios  
plot(sa_x13_v2$decomposition, first_date = c(2015,1))

```

### Plots and data visualisation (2/2)

In version 3 
- final + NEW "autoplot" layout 
- regarima not available (yet ?)
- SI ratios + NEW ggplot layout 

```{r,eval=TRUE, include=TRUE}
# version 3
# remotes::install_github("AQLT/ggdemetra3",INSTALL_opts = "--no-multiarch")
# library(ggdemetra3)
ggdemetra3::siratioplot(sa_x13_v3)
ggdemetra3::ggsiratioplot(sa_x13_v3)
ggplot2::autoplot(sa_x13_v3)


```


## Customizing specifications

### Customizing specifications: general steps 

To customize a specification you must 
- start with a valid specification, usually one of the defaut specs (equivalent to cloning a spec in GUI)
- create a new spec 
- apply the new spec to a series 

Some differences between v2 and v3

### Customizing specifications: in version 2

Direct parameter modification as arguments of the spec function 
```{r,eval=FALSE, include=TRUE}
# version 2
# changing estimation span, imposing additive model and adding user defined ouliers 
# first create a new spec modifying the previous one 
spec_1<- x13_spec(sa_x13_v2)
spec_2<- x13_spec(spec_1, estimate.from = "2004-01-01",
                  usrdef.outliersEnabled = TRUE,
                             usrdef.outliersType = c("LS", "AO"),
                             usrdef.outliersDate = c("2008-10-01", "2018-01-01"),
                             transform.function = "None") # additive model
# here the reg-arima model will be estimated from  "2004-01-01" 
# the decomposition will be run on the whole span 

# new sa processing
sa_x13_v2_2<-RJDemetra::x13(serie_brute,spec_2)
sa_x13_v2_2$final$series

```


### Customizing specifications: in version 3 

Use direct and specific `set_` functions 
- for the preprocessing step (functions defined in `rjd3modelling`):

`set_arima()`, `set_automodel()`, `set_basic()`, `set_easter()`, `set_estimate()`, `set_outlier()`, `set_tradingdays()`, `set_transform()`, `add_outlier()` and `remove_outlier()`, `add_ramp()` and `remove_ramp()`, `add_usrdefvar()`

- for the decomposition step in X13 (function defined in `rjd3x13`):
 `set_x11()`
 
- for the decomposition step in Tramo-Seats (function defined in `rjd3tramoseats`):
 `set_seats()`
 
- for the benchmarking step (function defined in `rjd3modelling`):
 `set_benchmarking()`

New v3 feature, same options available as in GUI.

### Customizing specifications in version 3: example
```{r,eval=FALSE, include=TRUE}
######### spec custo in v3
# start with default spec 
spec_1 = spec_x13_default("RSA3")
# or start with existing spec (no extraction function needed)
spec_1<-sa_x13_v3_UD$estimation_spec

# set a new spec
## add outliers 
spec_2 = rjd3modelling::add_outlier(spec_1,
                  type = c("AO"), c("2015-01-01", "2010-01-01"))
## set trading days
spec_2<-rjd3modelling::set_tradingdays(spec_2,
    option = "workingdays" )
# set x11 options 
spec_2<-set_x11(spec_2,henderson.filter = 13)
# apply with `fast.x13` (results only)
fast.x13(y,spec_2)

```


### Adding user-defined regressors 

In version 2: regressors added directly to the specification 

In version 3: new notion of "context"
an additionnal concept designed to
- 
- 

### Adding user-defined regressors in v2

```{r,eval=FALSE, include=TRUE}
# defining user defined trading days 
spec_4 <- x13_spec(spec_1,
tradingdays.option = "UserDefined",
tradingdays.test ="None",
usrdef.varEnabled = TRUE,
# the user defined variable will be assigned to the calendar component
usrdef.varType="Calendar",
usrdef.var=td_regs ) # regressors have to be a single or multiple TS 
# new sa processing
sa_x13_v2_4<-x13(serie_brute,spec_4)
# user defined intervention variable  
spec_5 <- x13_spec(spec_1,
                   usrdef.varEnabled = TRUE,
                   # the user defined variable will be assigned to the trend component
                   usrdef.varType="Trend",
                   usrdef.var=x ) # x has to to be a single or multiple TS 
# new sa processing
sa_x13_v2_5<-x13(serie_brute,spec_5)
```

### Adding user-defined regressors in version 3

```{r,eval=FALSE, include=TRUE}
# defining user defined trading days 
td_reg1<- rjd3modelling::td(12, start=start(y_raw),length = length(y_raw),groups = c(1,1,1,1,1,0,0))

context<-rjd3modelling::modelling_context(variables=list(a=xvar))

spec <- rjd3x13::spec_regarima_default(name = "rg3") |>
  rjd3modelling::add_usrdefvar(id = "r.a")

reg_a_estimation<-rjd3x13::regarima(window(ts, start=1985, end=2013),sp,context = context)

# if user_def variable to tren d? how to chose component ?
# regressors have to be added one by one 
```

## Refreshing data 

### Estimation spec vs result_spec

Possibility of refreshing data is new feature of version 3.

The "sa_model" generated with an estimation:
- new handling of spec (no extraction needed)
- notion of 
    - estimation spec (domain spec): set of customizable constraints
```{r, eval=FALSE, include=TRUE}
sa_x13_v3$estimation_spec$regarima$arima
```
    - result spec (or point spec)
```{r, eval=FALSE, include=TRUE}

```
    
- in v2 could only retrieve point spec 
- in v3 your are able to restimate the result spec inside the domain (estimation spec) freeing constriants on some parameters : just like in GUI

### Steps for refreshing data

```{r,eval=FALSE, include=TRUE}

current_result_spec<-sa_x13_v3$result_spec
current_domain_spec<-sa_x13_v3$estimation_spec

# generate NEW spec for refresh 
refreshed_spec<-x13.refresh(current_spec, # point spec to be refreshed
            current_domain_spec, #domain spec (set of constraints)
            policy = "Outliers",
            period = 12, # monthly series
            start = "2017-01-01",
            end = NULL)

# apply the new spec on new data : y_new= y_raw + 3 months
sa_x13_v3_refresh<-x13(y_new,refreshed_spec)
# what will be the domain spec here ?
# domain spec = point spec ?
```
- Outliers identiication : more flaxible the last ouliers or all outleirs in v2, here the span can be customized 
(Warning: x13.refresh hasn't been thouroughly tested yet)

### Refresh Policies 

- "FreeParameters", 
-  "Complete": 
- "Outliers_StochasticComponent", 
- "Outliers",
- "FixedParameters", 
- "FixedAutoRegressiveParameters", 
- "Fixed", 


### User-defined parameters: summary 

- what's new ? 
- whats's missing ?

# SA of High-Frequency data 

### SA of High-Frequency data

High-frequency data can 


In github repo full presnetations about {rjd3highfreq} 

# Generating User-defined auxilary variables 


## calendars

### calendars 

here new functionnality of v3, rjd3modelling package

## outliers and intervention variables 

### outliers and intervention variables 

(using this variables already presented, now focus on generation)



intervention bug in rj3modelling ?

# Conclusion 

### Conclusion on SA in R

What has v3 brought to the table ?





