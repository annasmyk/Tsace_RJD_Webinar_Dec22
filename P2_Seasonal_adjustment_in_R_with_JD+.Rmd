---
title: |
 | Using JDemetra+ in R: from version 2 to version 3 
 | Presentation 2: Seasonal adjustment in R
subtitle: "TSACE Webinar, Wednesday December 14th 2022"
author: "Anna Smyk and Tanguy Barthelemy"
division: |
    | With the collaboration of Alain Quartier-la-tente
    | 
logo: "img/SACElogo"
automaticcontents: true
automaticcontentstext: "Contents"
output:
    beamer_presentation:
        template: template_Beamer.tex
        keep_tex: yes
        theme: TorinoTh
        slide_level: 3
        includes:
          in_header: preamble_beamer.tex
themeoptions: "coding=utf8,language=english"
classoption: 'usepdftitle=false,french' #handout
fontsize: 10pt
bibliography: [biblio.bib]
biblio-style: unsrtnat
natbiboptions: [numbers]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = F, 
                      fig.align = 'center',
                      fig.path = "img/markdown-")
library(knitr)
library(kableExtra)
library(microbenchmark)
library(ggplot2)
library(RJDemetra)
library(rjd3toolkit)
library(rjd3modelling)
library(rjd3sa)
library(rjd3arima)
library(rjd3x13)
library(rjd3tramoseats)
library(rjdemetra3)
library(ggdemetra3)

# library(rjd3sts)
# library(rjd3highfreq)

# library(rjd3bench)
fig.ext <- "pdf"
is_html <- knitr::is_html_output()
is_latex <- knitr::is_latex_output()
fig.ext = "pdf"
if(is_html){
    fa_arrow_circle_right <- '<i class="fas fa-arrow-circle-right"></i>'
    fa_r_project <- '<i class="fab fa-r-project"></i>'
}else {
    if(is_latex){
        fa_arrow_circle_right <- "\\faIcon{arrow-circle-right}"
        fa_r_project <- "\\faIcon{r-project}"
        fa_java <- "\\faIcon{java}"
    }else {
        fa_arrow_circle_right <- "->"
        fa_r_project <- 'R'
    }
}
options(width = 60)
def.par <- par(no.readonly = TRUE)
```

```{r, eval=TRUE, echo=FALSE}
ipi<-read.csv2("Data/IPI_nace4.csv")
ipi$date<-as.Date(ipi$date,format="%d/%m/%Y")
ipi[,-1]<-sapply(ipi[,-1],as.numeric)
# creating a TS object from a data frame 
y_raw<-ts(ipi[,"RF3030"],frequency=12,start=c(1990,1),end=c(2019,9))


```

# Introduction 

### Outline table 

### Data formats

here, no workspace structure 
- assets
- shortcomings 


### SA process 

- identifying seasonality 
- pre treatement 
- decomposition 
- output series 
- diagnostics 
- customize parameters 
- repeat..

comp with GUI main panels ?

### rjd3 suite of packages for SA

in v2 : 

in v3: more tools (tests,...)



# SA (or Time series) tools

### Identifying seasonal patterns 

### Normality test

### Autocorrelation 


# X13 (Tramo-seats)

## Quick Launch with default specifications 

### Quick Launch with default specifications (1)

specifications 
- x13
- regarima 
- x11 (one less spec in default x13)

- Specification: created with `spec_x11_default()`, `spec_x13_default()`, `spec_regarima_default()` 

spec_regarima_default(name = c("rg4", "rg0", "rg1", "rg2c", "rg3", "rg5c"))

spec_x13_default(name = c("rsa4", "rsa0", "rsa1", "rsa2c", "rsa3", "rsa5c"))

spec_x11_default()

### Quick Launch with default specifications (2)

- Apply model with `x11()`, `x13()`, `fast.x13()`, `regarima()`, `fast.regarima()`

### Running SA estimation process

in version 2
```{r,eval=TRUE, include=TRUE}
# X13
sa_x13_v2<-RJDemetra::x13(y_raw, spec ="RSA5c")

#Tramo-Seats
sa_ts_v2<-RJDemetra::tramoseats(y_raw, spec ="RSAfull")
```

in version 3
```{r,eval=TRUE, include=TRUE}
#X13
sa_x13_v3 <- rjd3x13::x13(y_raw, spec= "RSA5")

#Tramo seats
sa_ts_v3 <- rjd3tramoseats::tramoseats(y_raw, spec= "RSAfull")

```

affichage output ?


### Running only pre-adjustment


in version 2
```{r,eval=TRUE, include=TRUE}
# X13 (different default spec names, cf help pages)
sa_x13_v2<-RJDemetra::regarima_x13(y_raw, spec ="RG5c")

#Tramo-Seats : NO TRAMO alone ?

```

in version 3
```{r,eval=TRUE, include=TRUE}
#X13
sa_regarima_v3 <- rjd3x13::regarima(y_raw)

#Tramo seats (if no spec indicated what is the defalut ?)
# retrouver en 
sa_tramo_v3 <- rjd3tramoseats::tramo(y_raw)

# "fast." versions...
```

affichage output ?


### Running only decomposition

in version 2
```{r,eval=TRUE, include=TRUE}
# X13
sa_x13_v2<-RJDemetra::x13(y_raw, spec ="RSA5c")

#Tramo-Seats
sa_ts_v2<-RJDemetra::tramoseats(y_raw, spec ="RSAfull")
```

in version 3
```{r,eval=TRUE, include=TRUE}
#X13
sa_x13_v3 <- rjd3x13::x13(y_raw, spec= "RSA5")

#Tramo seats
sa_ts_v3 <- rjd3x13::x13(y_raw, spec= "RSAfull")

```

affichage output ?


## Rerieving output and data visualization

### Output structure  v2
show the list of lists
do a new version 

### Output structure  v3 (cf txt file)
show the NEW list of lists

highlight deifferences: 
- specs
- specs direct accessible + 2 concepts
(spec in v12 was point spec;, more about this in refresh section)

### Retrieve output series 

- final
intermediate computations 
- from preadjustement

highlight differences v2 vs v3


### Retrieve Diagnostics 

### Plots and data visualisation 
in v2
in v3 : .mostly in ggdemetra3 for now ..






## Customizing specifications

### Customizing specifications 

v2: 
- step 1: extract spec
- step 2: use the spec function with user-defined arguments
v3:
- use direct set_ functions 

For the preprocessing step (functions defined in `rjd3modelling`):

`set_arima()`, `set_automodel()`, `set_basic()`, `set_easter()`, `set_estimate()`, `set_outlier()`, `set_tradingdays()`, `set_transform()`, `add_outlier()` and `remove_outlier()`, `add_ramp()` and `remove`_ramp()`

\bcinterdit `add_usrdefvar()` not yet available

For the decopmostion step (function defined in `rjd3x13`):
 `set_x11()`
 
Adding Benchamarking (like in GUI) (in ?)

### Example of customizing specif

sp = spec_x13_default("rg5c")
y = rjd3toolkit::ABS$X0.2.09.10.M
fast.x13(y, spec = sp)
sp = rjd3modelling::add_outlier(sp,
                 type = c("AO"), c("2015-01-01", "2010-01-01"))
sp =  rjd3modelling::set_transform(
   rjd3modelling::set_tradingdays(
     rjd3modelling::set_easter(sp, enabled = FALSE),
    option = "workingdays"
  ),
  fun = "None"
)
sp = set_x11(sp,
             henderson.filter = 13)
fast.x13(y, spec = sp)


### Adding a context 
new in v3, relevant ?

### Customizing calendar regressors 
in v2
in v3

### Intervention variables
in v2

in v3 : still a bug

### User-defined parameters: summary 
BILAN 
- what's new ? 
- whats's missing ?


## Refreshing data 

### Refreshing data 

new feature of v3

- new handling of spec (no extraction needed)
- notion of point spec and domain spec
- in v2 could only retrieve point spec 
- generatingn new spec for refesh
- new estimation




# Tramo-seats 

### rjd3tramoseats package  

here (optionnal) what is different from the way rjd3x13 operates


# SA of High-Frequency data 

### SA of High-Frequency data
tool oriented 


# Generating User-defined auxilary variables 


## calendars

### calendars 

here new functionnality of v3, rjd3modelling pacakage

## outliers and intervention variables 

### outliers and intervention variables 

(using this variables already presented, now focus on generation)



intervention bug in rj3modelling ?

# Conclusion 

### Conclusion on SA in R

What has v3 brought to the table ?





